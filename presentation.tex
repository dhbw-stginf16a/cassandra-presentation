\documentclass[
  10pt
%, handout
]{beamer}

\usepackage{pgfpages}

\usepackage[T1]{fontenc}

%\setbeameroption{show notes on second screen}

\setbeamertemplate{section in toc}[sections numbered]

\usetheme[
  numbering=fraction
]{metropolis}
\usepackage{appendixnumberbeamer}

\usepackage{booktabs}
\usepackage[scale=2]{ccicons}

\usepackage{pgfplots}
\usepgfplotslibrary{dateplot}

\usepackage{xspace}
\newcommand{\themename}{\textbf{\textsc{metropolis}}\xspace}

\usepackage{graphicx}
\usepackage{listings}

\usepackage{lmodern}

\usepackage{eurosym}
\usepackage{amsmath, amssymb}
\usepackage[binary-units=true]{siunitx}
\DeclareSIUnit{\EUR}{\text{\euro}}

\usepackage{xcolor}
\newcommand\crule[3][black]{\textcolor{#1}{\rule{#2}{#3}}}
\definecolor{aswe-reactive}{cmyk}{1,0.9,0,0}
\definecolor{aswe-proactive}{cmyk}{0.6,0.9,0,0}
\definecolor{aswe-preferences}{cmyk}{0,0.75,1,0}
\definecolor{aswe-data}{cmyk}{0.85,0.1,1,0}

\setcounter{tocdepth}{1}  % Hide subsections in table of contents

% Content

\title{Introduction to Apache Cassandra}
\subtitle{}
\date{April 10, 2019}
\author{David Marchi, Daniel Sch√§fer, Erik Zeiske}
% \titlegraphic{\hfill\includegraphics[height=1.5cm]{logo.pdf}}

\begin{document}

\maketitle

\begin{frame}{Agenda}
  \tableofcontents[pausesections]
\end{frame}

\section{Overview}  % David

\begin{frame}{History}
  \begin{itemize}
    \item 2008, Developed by Facebook for inbox searching
    \item 2010, Proper Apache project
    \item Mainly developed and supported by Datastax
    \item 2019, 11th most popular database (db-engines.com)
  \end{itemize}
\end{frame}

\begin{frame}{Deployments}
  Widely used by large companies in big clusters:

  \begin{tabular}{@{}ll}
    \hline
    CERN    & Storage backend for ATLAS detector \\
    \hline
    Netflix & 2,500 nodes, 420 TB, over 1 trillion requests per day \\
            & Migrated from Oracle to Cassandra \\
    \hline
    eBay    & 6 billion writes and 5 billion reads daily \\
            & Single Cassandra table of 40TB \\
    \hline
    \onslide<2->
    Apple   & >75k Cassandra nodes with \textbf{10PB} in production \\
            & Several clusters with \textbf{1000+ nodes each!} \\
    \hline
  \end{tabular}

% https://cdsweb.cern.ch/record/1432912/files/ATL-DAQ-SLIDE-2012-067.pdf
% https://www.slideshare.net/adrianco/migrating-netflix-from-oracle-to-global-cassandra/28-Remote_Copies_Cassandra_duplicates_across
% https://www.slideshare.net/jaykumarpatel/cassandra-at-ebay-13920376
% https://www.datastax.com/resources/casestudies/ebay
\end{frame}

\begin{frame}{Properties}
  \begin{itemize}
    \item<1-> Wide Column Store
    \item<2-> Table-like but not relational
    \item<3-> Distributed
    \item<4-> Masterless
    \item<5-> Free software project of the Apache Foundation
  \end{itemize}
  \note<1>[item]{Later more what "Wide Column Store" means}
  \note<5>[item]{Originally developed by Facebook in 2008}
\end{frame}

\section{Wide Column Store}  % David
\begin{frame}{Wide Column Store}
  \begin{itemize}
    \item<1-> Tabular but not relational
    \item<2-> \textbf{NOT} column oriented! Rows are stored together
    \item<3-> A row can have missing columns (Not stored on disk $\rightarrow$ sparse)
    \item<4-> Like key-value store where the value can have a subset of a predefined set of columns
  \end{itemize}

  \onslide<5->
  Interpretation of the name: \\
  Key value store with wide (complex) values that consist of columns

  \onslide<6->
  "Sparse, distributed multi-dimensional sorted map"
  % Chang, F., Dean, J., Ghemawat, S., Hsieh, et al. (2008). Bigtable: A distributed storage system for structured data. ACM Transactions on Computer Systems (TOCS), 26(2), 4

  \note<2>[item]{Unlike Vertica or SAP HANA}
\end{frame}

\section{Use-Cases Cassandra is (not) suited for}  % David
\begin{frame}{Pros and cons}
  \begin{columns}[T]
    \onslide<+->
    \begin{column}{0.55\textwidth}
      \underline{Use if you want/need}

      \begin{enumerate}[\textbf{\textcolor{aswe-data}{+}}]
        \item<+-> Fast writes \\ (high throughput, not latency)
        \item<+-> High availability
        \item<+-> Easy (linear) horizontal scalability
        \item<+-> No master $\rightarrow$ \\ Read from and write to any node
        \item<+-> Flexible schema \\ (rows can have missing columns)
        \item<+-> Globally distributed cluster
      \end{enumerate}
      \note[item]{Writes include \lstinline{INSERT} \lstinline{UPDATE} \lstinline{DELETE}}
      \note[item]{Inter-node communication doesn't increase with more nodes}
      \note[item]{Missing columns aren't even saved to disk (sparse)}
    \end{column}

    \onslide<+->
    \begin{column}{0.45\textwidth}
      \underline{Don't use if you want/need}

      \begin{enumerate}[\textbf{\textcolor{aswe-preferences}{-}}]
        \item<+-> Single system instance
        \item<+-> Ever changing queries
        \item<+-> Lots of updates and deletes interspersed with reads
        \item<+-> Transactions (ACID)
        \item<+-> Relations (joins, ...)
        \item<+-> Column aggregation (\lstinline{GROUP BY})
        \item<+-> \lstinline{AUTO INCREMENT}
      \end{enumerate}
      \note[item]{Cassandra is \textbf{NOT} column oriented}
    \end{column}
  \end{columns}
\end{frame}

\begin{frame}{Suitable usecases}
  % TODO: Improve this slide - separate abstract and concrete usecases from eachother
  Concrete use-cases
  \begin{itemize}
    \item Recording of financial transaction
    \item Time series data (logs of any kind, e.g. sensors with huge outputs)
    \item Tracking status
    \item Anything append only
  \end{itemize}
\end{frame}

\section{How to use CQL}  % Erik
\subsection{Compare to API (key-value)}
\subsection{Compare to SQL}

\section{How to model data (or rather tables)}  % David

\subsection{Secondary index}  % Daniel

\begin{frame}[fragile]{Secondary index - Why}
  Make it possible to filter by a non primary-key column
  \begin{semiverbatim}
  \onslide<1->
  cqlsh:db> CREATE TABLE users (
  cqlsh:db>  username varchar PRIMARY KEY,
  cqlsh:db>  age int
  cqlsh:db> );
  cqlsh:db> SELECT * FROM users WHERE age = 5;
  \onslide<2->
  cqlsh:db> \textcolor{red}{InvalidRequest: [might filter data]}
  \onslide<3->
  cqlsh:db> CREATE INDEX ON users (age);
  cqlsh:db> SELECT * FROM users WHERE age = 5;

   username | age
   \--\--\--\--\--\--\--\--\--+\--\--\--\--
      timmy |   5
  \end{semiverbatim}
  \note<1-2>[item]{Unpredicatable performance $\rightarrow$ ALLOW FILTERING}
  \note<1-2>[item]{Has to go through all nodes and all of their data}
\end{frame}

\begin{frame}{Secondary index - Implementation}
  % https://www.datastax.com/wp-content/uploads/2017/01/Native2i-Distributed-Index-3.png
  \includegraphics[width=1.0\textwidth]{resources/distributed_index.png}
  \note[item]{NOT tree, regular table}
  \note[item]{Distributed, same location as data}
  \note[item]{Restrict partition key $\rightarrow$ Find node}
  \note[item]{Heuristic to fetch data from likely nodes in stages}
\end{frame}

\begin{frame}{Secondary index - Summary}
  \begin{itemize}
    \item<1-> Distributed table with different primary key
    \item<2-> Located on same node as indexed data
      \begin{itemize}
        \item Fast to update
        \item Partitions as balanced as data
      \end{itemize}
    \item<3-> Good practice to restrict partition key as well
    \item<4-> Uses heuristic to fetch data from likely nodes $\rightarrow$ \textbf{Use LIMIT}
  \end{itemize}
  \note<3>[item]{Partition key $\rightarrow$ only needs to search single node}
\end{frame}

\begin{frame}{Secondary index - When not to use}
  Avoid columns
  \begin{itemize}
    \item<1-> with very high cardinality (e.g. user id)
    \item<2-> with very low cardinality (e.g. country name)
    \item<3-> that are updated/deleted very frequently
  \end{itemize}
  \note<1>[item]{Low chance of finding - no partition key $\rightarrow$ queries all nodes}
  \note<2>[item]{Results in huge index rows}  % TODO: Think about a good explanation
  \note<3>[item]{Updates have to update two tables}
  \note<3>[item]{Tombstones are stored in index - hard limit of 100K $\rightarrow$ Query FAILS}
\end{frame}

\section{Local reads and writes}  % Erik
\begin{frame}{Write process}
  \includegraphics[width=\textwidth]{resources/local_write.png}
\end{frame}

\begin{frame}{Read process}
  \includegraphics[width=\textwidth]{resources/local_read.png}
\end{frame}

\subsection{How data is stored on disk}

\section{How the cluster works}  % Daniel

\begin{frame}{Token Ring}
  % http://abiasforaction.net/wp-content/uploads/2015/01/Cassandra-Ring.jpg
  \includegraphics[width=1.0\textwidth]{resources/token_ring.jpg}
\end{frame}

\begin{frame}{Ring with replicas and virtual nodes}
  % https://engineeringblog.yelp.com/images/posts/monitoring-cassandra-at-scale/cassandra_ring.png
  \includegraphics[width=1.0\textwidth]{resources/replica_ring.png}
\end{frame}

\begin{frame}{Rebalancing}
  % https://www.datastax.com/wp-content/uploads/2012/02/numofmoves.png
  \includegraphics[width=1.0\textwidth]{resources/rebalancing.png}
\end{frame}

\section{Distributed writes and reads (CAP)}  % Daniel

\begin{frame}{CAP Theorem}
  \begin{itemize}
    \item AP by default
    \item Can be tuned on a continuum towards CP
    \item AC not possible  % https://codahale.com/you-cant-sacrifice-partition-tolerance/
  \end{itemize}
\end{frame}

\begin{frame}{How data is replicated}
  % Draw manually if someone's bored
  % https://docs.datastax.com/en/cassandra/3.0/cassandra/images/arc_write-singleDCConOne.png
  \includegraphics[width=1.0\textwidth]{resources/distributed_write.png}
\end{frame}

\begin{frame}{How data is replicated}
  % Can fail!
  \begin{enumerate}
    \item<1-> Client asks any node (becomes coordinator)
    \item<2-> Coordinator asks responsible nodes (replicas)
    \item<3-> When more than \lstinline{CL.write} nodes have confirmed write client is given answer
    \item<4-> Temporarily offline nodes are later reminded with a \textit{hinted-handoff}
  \end{enumerate}
\end{frame}

\begin{frame}{How data is replicated - Node down}
  % https://docs.datastax.com/en/cassandra/3.0/cassandra/images/dml_hinted_handoff.png
  \includegraphics[width=1.0\textwidth]{resources/hinted_handoff.png}
\end{frame}

\begin{frame}{How data is read with consensus}
  \begin{enumerate}
    \item<1-> Client asks any node (becomes coordinator)
    \item<2-> Coordinator asks responsible nodes (replicas)
    \item<3-> When more than \lstinline{CL.read} nodes have answered client is given answer
    \item<4-> Nodes that sent outdated data are sent a \lstinline{read_repair}
  \end{enumerate}
\end{frame}

\begin{frame}{CAP Theorem - Tunable Variables}
  \begin{itemize}
    \item<+-> Consistency: (\lstinline{ANY} $\rightarrow$ \textbf{\lstinline{ONE}} $\rightarrow$ \lstinline{QUORUM} $\rightarrow$ \lstinline{ALL})
      \begin{itemize}
        \item \lstinline{CL.Read}
        \item \lstinline{CL.Write}
      \end{itemize}
    \item<+-> Availability:
      \begin{itemize}
        \item \lstinline{ReplicationFactor} (1 $\rightarrow$ \textbf{3} $\rightarrow$ nodes)
        \item More nodes
      \end{itemize}
  \end{itemize}
\end{frame}

\section{Set up and must knows}  % Daniel

\begin{frame}{Setup - overview}
  \begin{enumerate}
    \item<1-> Get enough nodes ($\geq3$ with $8+$ cores and 32GB RAM, lots of disk)
    % http://cassandra.apache.org/doc/latest/operating/hardware.html
    \item<2-> Set up network (each node with own IP reachable from the others)
    \item<3-> Adapt configuration files
    \item<4-> Open firewall for necessary ports
    \begin{itemize}
      \item 7000: node $\leftrightarrow$ node (\lstinline{storage_port})
      \item 9042: client $\leftrightarrow$ node (\lstinline{native_transport_port})
    \end{itemize}
    \item<5-> Start seed nodes and then other nodes
    \item<6-> Use \lstinline{nodetool} or \lstinline{cqlsh} to interact with the cluster
  \end{enumerate}
  \note<1>[item]{Number for recommended nodes from Apache}
  \note<1>[item]{ECC RAM and SSD are recommended}
  \note<1>[item]{DataStax recommends keeping data per node near or below 1 TB}
  % https://docs.datastax.com/en/dse-planning/doc/planning/planningHardware.html
  \note<2>[item]{Cloud is perfectly suited for this}
  \note<2>[item]{Two nodes cannot share a broadcast address (e.g. NAT)}
\end{frame}

\begin{frame}[fragile]{How to set up - Initial node}
  /etc/cassandra/cassandra.yaml
  \begin{semiverbatim}
# Opens socket on this address
listen_address: "192.168.0.2"
# Tells other nodes its reachable on this address
broadcast_address: "3.14.1.59"

seed_provider:
  - class_name: org.apache.cassandra.locator.SimpleSeedProvider
    parameters:
      - seeds "3.14.1.59"

# Enable client communication
start_native_transport: true
  \end{semiverbatim}
  \note[item]{Own broadcast address is in seeds $\rightarrow$ Creates own cluster}
  \note[item]{For single node cluster use \lstinline{localhost} everywhere}
\end{frame}

\begin{frame}[fragile]{How to set up - Further nodes}
  /etc/cassandra/cassandra.yaml
  \begin{semiverbatim}
# Opens socket on this address
listen_address: "\textbf{192.168.1.2}"
# Tells other nodes its reachable on this address
broadcast_address: "\textbf{6.28.3.18}"

seed_provider:
  - class_name: org.apache.cassandra.locator.SimpleSeedProvider
    parameters:
      - seeds "3.14.1.59"

# Enable client communication
start_native_transport: true
  \end{semiverbatim}
  \note[item]{Seeds is a comma separated "list" of IPs}
  \note[item]{Three per datacenter recommended}
\end{frame}

\begin{frame}{More configuration}
  \begin{itemize}
    \item Tune JVM parameters like heap size in \lstinline{cassandra-env.sh}
    \item Increase the number of tokens (virtual nodes) with \lstinline{num_tokens}
    \item Other performance, architecture or security tuning
  \end{itemize}
\end{frame}

\begin{frame}{Security}
  \begin{itemize}
    \item<1-> Use a firewall to not expose it to the public internet
    \item<2-> Internode communication with TLS
    \item<2-> Client $\leftrightarrow$ Node communication with TLS
    \item<3-> JMX management only on localhost and with auth
    \item<4-> Authentication with password
    \item<5-> Disable default role
    \item<5-> Use roles
  \end{itemize}
  \note<1>[item]{Basic linux due diligence}
  \note<2>[item]{TLS is always good $\rightarrow$ Encryption, Authenticity}
  \note<5>[item]{There are no users, only roles (good RBAC model)}
\end{frame}

%\subsection{Things to keep in mind}
% How to set up as an admin / Must knows

\section{Summary and Conclusion}

\begin{frame}{Summary and Conclusion}
  \begin{itemize}
    \item<+-> Useful for \textit{logging} large amounts of data
    \item<+-> Highly available
    \item<+-> Not a replacement for RDBMS
    \item<+-> Sophisticated architecture
    \item<+-> Battle tested
    \item<+-> Fantastic for the use-cases its designed for
  \end{itemize}
\end{frame}

\appendix

\begin{frame}{Comparison - Other Wide Column Datastores}
  \begin{center}
    \begin{tabular}{l|l}
      Name & Description \\
      \hline
      Amazon DynamoDB & Amazon makes the decisions for you \\
      % Original developers of DynamoDB created Cassandra
      % Easy but less tunable
      % MultiCloud, Partitions, Nodes, Consistency level, ...
      % Cassandra based off of DynamoDB
      Google BigTable & Based on GFS (CP), Managed by Google \\
      % Can be used with Cassandra like architecture (default)
      ScyllaDB & Cassandra rewrite with better performance \\
      % C++ and better handling of multiple requests
      % Not yet all features and not "battle tested"
      Apache HBase & Similar data model, master/slave $\rightarrow$ CP\\
    \end{tabular}
  \end{center}
\end{frame}

\end{document}
